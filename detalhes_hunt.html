let usuarioDetalhes = null;
let huntAtualDetalhes = null; // Para armazenar os dados da hunt carregada
let contribuicaoRatingDetalhes = null; // Para o rating no modal desta página

// Gráficos (instâncias serão armazenadas aqui para poderem ser destruídas/atualizadas)
let graficoMeuXp = null;
let graficoMeuGold = null;

const usuarios = [ // Replique ou carregue de uma fonte comum se precisar do array de usuários aqui
  { email: "admin@admin.com", senha: "1", vip: true }
];


// --- Funções utilitárias (podem ser movidas para um arquivo .js comum) ---
function gerarEstrelasHtml(nota, maxEstrelas = 5) {
    const notaNum = parseFloat(nota);
    if (isNaN(notaNum)) return "N/A";

    let estrelas = "";
    const inteira = Math.floor(notaNum);
    const fracao = notaNum - inteira;

    for (let i = 0; i < inteira; i++) {
        estrelas += '<span class="estrela-cheia">★</span>';
    }

    if (fracao >= 0.25 && fracao < 0.75) {
        estrelas += '<span class="estrela-meia">★</span>'; // ☆ ou outro símbolo para meia
    } else if (fracao >= 0.75) {
        estrelas += '<span class="estrela-cheia">★</span>';
    }

    const restantes = maxEstrelas - Math.ceil(notaNum);
    for (let i = 0; i < restantes; i++) {
        estrelas += '<span class="estrela-vazia">☆</span>';
    }
    return estrelas;
}
// --- Fim Funções utilitárias ---


function carregarUsuarioSessaoDetalhes() {
    const usuarioJSON = localStorage.getItem('huntFinderUsuario');
    if (usuarioJSON) {
        usuarioDetalhes = JSON.parse(usuarioJSON);
    }
    atualizarInterfaceUsuarioDetalhes();
}

function fazerLogoutDetalhes() {
  usuarioDetalhes = null;
  localStorage.removeItem('huntFinderUsuario');
  atualizarInterfaceUsuarioDetalhes();
  // Opcional: redirecionar para index.html ou recarregar para limpar dados VIP
  window.location.reload();
}


function atualizarInterfaceUsuarioDetalhes() {
    const userStatusEl = document.getElementById('user-status-detalhes');
    const logoutBtnEl = document.getElementById('logout-btn-detalhes');
    const secoesVip = document.querySelectorAll('.vip-content');

    if (usuarioDetalhes) {
        userStatusEl.textContent = `Olá, ${usuarioDetalhes.email}${usuarioDetalhes.vip ? " (VIP)" : ""}`;
        logoutBtnEl.style.display = 'inline-block';
        if (usuarioDetalhes.vip) {
            secoesVip.forEach(sec => sec.style.display = 'block');
        } else {
            secoesVip.forEach(sec => sec.style.display = 'none');
        }
    } else {
        userStatusEl.textContent = 'Visitante. Faça login para recursos VIP.';
        logoutBtnEl.style.display = 'none';
        secoesVip.forEach(sec => sec.style.display = 'none');
    }
}

async function carregarDadosHunt() {
    const params = new URLSearchParams(window.location.search);
    const huntNome = params.get('huntNome');

    if (!huntNome) {
        document.getElementById('hunt-nome-titulo').textContent = 'Hunt não especificada.';
        return;
    }

    document.getElementById('hunt-nome-titulo').textContent = decodeURIComponent(huntNome);

    try {
        // Carregar todos os bancos para encontrar a hunt
        const [huntsFree, huntsPremium, huntsPlayerBase, huntsPlayerDetails] = await Promise.all([
            fetch("banco_free.json").then(r => r.ok ? r.json() : []).catch(() => []),
            fetch("banco_premium.json").then(r => r.ok ? r.json() : []).catch(() => []),
            fetch("banco_player.json").then(r => r.ok ? r.json() : []).catch(() => []),
            fetch("banco.json").then(r => r.ok ? r.json() : []).catch(() => [])
        ]);

        let todasAsHunts = [...huntsFree, ...huntsPremium];

        // Combinar player hunts (base + details)
        const playerHuntsCombinadas = huntsPlayerBase.map(baseHunt => {
            const detailHunt = huntsPlayerDetails.find(dh => dh.nome === baseHunt.nome);
            return detailHunt ? { ...baseHunt, ...detailHunt } : baseHunt;
        });
        huntsPlayerDetails.forEach(detailHunt => {
            if (!playerHuntsCombinadas.some(h => h.nome === detailHunt.nome)) {
                playerHuntsCombinadas.push(detailHunt);
            }
        });
        todasAsHunts = todasAsHunts.concat(playerHuntsCombinadas);


        huntAtualDetalhes = todasAsHunts.find(h => h.nome === decodeURIComponent(huntNome));

        if (huntAtualDetalhes) {
            popularDadosHunt(huntAtualDetalhes);
            if (usuarioDetalhes && usuarioDetalhes.vip) {
                exibirMetricasComunidade(huntAtualDetalhes);
                exibirMinhasMetricas(huntAtualDetalhes); // Carregar métricas pessoais se VIP
                document.getElementById('btn-abrir-modal-contribuir-detalhes').onclick = () => abrirModalContribuicaoDetalhes(huntAtualDetalhes);
            }
        } else {
            document.getElementById('hunt-nome-titulo').textContent = `Hunt "${decodeURIComponent(huntNome)}" não encontrada.`;
            document.getElementById('info-geral').innerHTML = '<p>Não foi possível carregar os dados desta hunt.</p>';
        }
    } catch (error) {
        console.error("Erro ao carregar dados da hunt:", error);
        document.getElementById('info-geral').innerHTML = '<p>Ocorreu um erro ao carregar os dados. Tente novamente mais tarde.</p>';
    }
}

function popularDadosHunt(hunt) {
    document.getElementById('hunt-nivel-min').textContent = hunt.nivel_min ?? 'N/A';
    document.getElementById('hunt-vocacoes').textContent = (hunt.vocacoes && hunt.vocacoes.join(', ')) || 'N/A';
    document.getElementById('hunt-tipo').textContent = hunt.tipo?.toUpperCase() || 'N/A';
    document.getElementById('hunt-localizacao-texto').textContent = hunt.localizacao || 'Não especificada';

    // Mapa (exemplo, precisará da URL correta no seu JSON ou de uma lógica de busca)
    if (hunt.url_mapa_hunt) { // Supondo que você adicione este campo ao seu JSON
        document.getElementById('hunt-mapa-container').innerHTML = `<img src="${hunt.url_mapa_hunt}" alt="Mapa da hunt ${hunt.nome}">`;
    } else if (hunt.localizacao) {
        // Tentar usar o TibiaMaps.io (exemplo de link, não embed direto sem API deles)
        // Poderia ser um link para o tibiamaps.io ou uma imagem estática baseada na localização
        // `document.getElementById('hunt-mapa-container').innerHTML = `<a href="https://tibiamaps.io/map#${encodeURIComponent(hunt.localizacao)}" target="_blank">Ver no TibiaMaps.io</a>`;
        // Ou, melhor, use a lógica de imagem se tiver o 'url_mapa_hunt'
         document.getElementById('hunt-mapa-container').innerHTML = `<p>Mapa não disponível.</p>`;
    }


    // Drops Comuns
    const dropsComunsEl = document.getElementById('lista-drops-comuns');
    if (hunt.drops && hunt.drops.length > 0) {
        dropsComunsEl.innerHTML = hunt.drops.map(item => {
            const nomeImg = item.replace(/ /g, "_");
            // Priorizar TibiaWiki BR, depois Fandom como fallback (ajustar URL se necessário)
            const urlImg = `https://www.tibiawiki.com.br/images/${nomeImg}.gif`;
            // const urlFandom = `https://static.wikia.nocookie.net/tibia/images/.../${nomeImg}.gif`; // Precisa do padrão correto
            return `<div class="item-card">
                        <img src="${urlImg}" alt="${item}" title="${item}" onerror="this.src='placeholder_item.png'; this.onerror=null;"> <!-- Adicionar um placeholder_item.png -->
                        <div class="item-info"><strong>${item}</strong></div>
                    </div>`;
        }).join('');
    } else {
        dropsComunsEl.innerHTML = '<p>Nenhum drop comum notável listado.</p>';
    }

    // Melhores Loots
    const melhoresLootsEl = document.getElementById('lista-melhores-loots');
    if (hunt.melhores_loots && hunt.melhores_loots.length > 0) {
        melhoresLootsEl.innerHTML = hunt.melhores_loots.map(loot => {
            const nomeLootImg = loot.nome.replace(/ /g, "_");
            const urlLootImg = `https://www.tibiawiki.com.br/images/${nomeLootImg}.gif`;
            return `<div class="item-card">
                        <img src="${urlLootImg}" alt="${loot.nome}" title="${loot.nome}" onerror="this.src='placeholder_item.png'; this.onerror=null;">
                        <div class="item-info">
                            <strong>${loot.nome}</strong>
                            <span class="loot-valor">${(loot.valor / 1000).toFixed(0)}k</span>
                            <span class="loot-chance">${(typeof loot.chance === 'number' ? loot.chance.toFixed(2) : loot.chance)}%</span>
                        </div>
                    </div>`;
        }).join('');
    } else {
        melhoresLootsEl.innerHTML = '<p>Nenhum "melhor loot" listado.</p>';
    }

    // Monstros (Exemplo - precisará de dados de monstros no JSON ou API)
    listarMonstrosDaHunt(hunt); // Chamar a função para buscar/exibir monstros
}

async function listarMonstrosDaHunt(hunt) {
    const listaMonstrosEl = document.getElementById('lista-monstros');
    listaMonstrosEl.innerHTML = '<p>Buscando informações dos monstros...</p>';

    // Cenário 1: Monstros estão no JSON da hunt (ex: hunt.monstros_na_hunt)
    if (hunt.monstros_na_hunt && hunt.monstros_na_hunt.length > 0) {
        let monstrosHtml = "";
        for (const monstroInfo of hunt.monstros_na_hunt) { // monstroInfo = { nome: "Dragon", xp: 700, imagem_url: "..." }
            let xp = monstroInfo.xp || 'N/A';
            let hp = monstroInfo.hp || 'N/A';
            let imgUrl = monstroInfo.imagem_url; // Se você já tiver no seu JSON

            // Se não tiver imagem_url ou xp/hp no JSON, tentar buscar na API TibiaData
            if (!imgUrl || xp === 'N/A' || hp === 'N/A') {
                try {
                    const response = await fetch(`https://api.tibadata.com/v3/creature/${encodeURIComponent(monstroInfo.nome)}`);
                    if (response.ok) {
                        const dataApi = await response.json();
                        if (dataApi.creature) {
                            if (xp === 'N/A') xp = dataApi.creature.experience_points || 'N/A';
                            if (hp === 'N/A') hp = dataApi.creature.hitpoints || 'N/A';
                            if (!imgUrl) imgUrl = dataApi.creature.image_url;
                        }
                    }
                } catch (e) {
                    console.warn(`Não foi possível buscar dados da API para ${monstroInfo.nome}: ${e}`);
                }
            }
             // Fallback se a imagem ainda não foi encontrada
            if (!imgUrl) imgUrl = `https://www.tibiawiki.com.br/images/${monstroInfo.nome.replace(/ /g, "_")}.gif`;


            monstrosHtml += `
                <div class="monstro-card">
                    <img src="${imgUrl || 'placeholder_monstro.png'}" alt="${monstroInfo.nome}" title="${monstroInfo.nome}" onerror="this.src='placeholder_monstro.png'; this.onerror=null;">
                    <div class="monstro-info">
                        <strong>${monstroInfo.nome}</strong>
                        <span class="monstro-xp">${xp}</span>
                        <span class="monstro-hp">${hp}</span>
                    </div>
                </div>`;
        }
        listaMonstrosEl.innerHTML = monstrosHtml || '<p>Nenhum monstro listado para esta hunt no banco de dados.</p>';
    } else {
        // Cenário 2: Lógica para deduzir monstros (mais complexo, ou apenas mostrar N/A)
        listaMonstrosEl.innerHTML = '<p>Informações de monstros não disponíveis para esta hunt.</p>';
    }
}


// --- Funções VIP ---
function exibirMetricasComunidade(hunt) {
    const contribs = hunt.contribuicoes || [];
    const xpArr = contribs.map(c => c.xp).filter(n => typeof n === 'number' && !isNaN(n));
    const goldArr = contribs.map(c => c.gold).filter(n => typeof n === 'number' && !isNaN(n));
    const ratingArr = contribs.map(c => c.avaliacao).filter(n => n !== null && n !== undefined && typeof n === 'number');

    document.getElementById('comunidade-xp-media').textContent = xpArr.length ? (xpArr.reduce((a, b) => a + b, 0) / xpArr.length).toFixed(0) + " xp/h" : "N/A";
    document.getElementById('comunidade-xp-min').textContent = xpArr.length ? Math.min(...xpArr) : "N/A";
    document.getElementById('comunidade-xp-max').textContent = xpArr.length ? Math.max(...xpArr) : "N/A";

    document.getElementById('comunidade-gold-media').textContent = goldArr.length ? (goldArr.reduce((a, b) => a + b, 0) / goldArr.length).toFixed(0) + " gp/h" : "N/A";
    document.getElementById('comunidade-gold-min').textContent = goldArr.length ? Math.min(...goldArr) : "N/A";
    document.getElementById('comunidade-gold-max').textContent = goldArr.length ? Math.max(...goldArr) : "N/A";

    const notaMedia = ratingArr.length ? ratingArr.reduce((a, b) => a + b, 0) / ratingArr.length : 0;
    document.getElementById('comunidade-avaliacao-media').textContent = notaMedia.toFixed(1);
    document.getElementById('comunidade-estrelas').innerHTML = gerarEstrelasHtml(notaMedia);
}

function exibirMinhasMetricas(hunt) {
    if (!usuarioDetalhes || !usuarioDetalhes.vip) return;

    const minhasContribs = (hunt.contribuicoes || []).filter(c => c.email_usuario === usuarioDetalhes.email && c.data_contribuicao)
        .sort((a, b) => new Date(a.data_contribuicao) - new Date(b.data_contribuicao)); // Ordena por data

    const semMinhasMetricasEl = document.getElementById('sem-minhas-metricas');
    const graficosContainerEl = document.getElementById('graficos-container');

    if (minhasContribs.length === 0) {
        semMinhasMetricasEl.style.display = 'block';
        graficosContainerEl.style.display = 'none';
        return;
    }
    semMinhasMetricasEl.style.display = 'none';
    graficosContainerEl.style.display = 'grid'; // ou 'block' dependendo do seu CSS


    const labels = minhasContribs.map(c => new Date(c.data_contribuicao).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit'}));
    const xpData = minhasContribs.map(c => c.xp);
    const goldData = minhasContribs.map(c => c.gold);

    // Destruir gráficos antigos se existirem
    if (graficoMeuXp) graficoMeuXp.destroy();
    if (graficoMeuGold) graficoMeuGold.destroy();

    // Gráfico de XP
    const ctxXp = document.getElementById('grafico-meu-xp').getContext('2d');
    graficoMeuXp = new Chart(ctxXp, {
        type: 'line', // ou 'bar'
        data: {
            labels: labels,
            datasets: [{
                label: 'Meu XP/h',
                data: xpData,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // Gráfico de Gold
    const ctxGold = document.getElementById('grafico-meu-gold').getContext('2d');
    graficoMeuGold = new Chart(ctxGold, {
        type: 'line', // ou 'bar'
        data: {
            labels: labels,
            datasets: [{
                label: 'Meu Gold/h',
                data: goldData,
                borderColor: 'rgba(255, 206, 86, 1)',
                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}


// --- Modal de Contribuição para página de detalhes ---
function abrirModalContribuicaoDetalhes(hunt) {
    if (!hunt) return;
    huntAtualDetalhes = hunt; // Garante que está usando a hunt correta
    contribuicaoRatingDetalhes = null; // Reseta o rating
    document.getElementById('modal-hunt-nome-detalhes').textContent = hunt.nome;
    document.getElementById('inputXpDetalhes').value = "";
    document.getElementById('inputGoldDetalhes').value = "";
    document.getElementById('inputLevelDetalhes').value = "";
    document.getElementById('servidorDetalhes').value = "";

    // Resetar estilo dos botões de rating
    document.querySelectorAll('#modal-contribuicao-detalhes .rating-btn').forEach(btn => {
        btn.classList.remove('selected');
        // Resetar para cor padrão se você tiver um estilo base
        btn.style.backgroundColor = '';
    });

    document.getElementById('modal-contribuicao-detalhes').style.display = 'flex';
}

function fecharModalContribuicaoDetalhes() {
    document.getElementById('modal-contribuicao-detalhes').style.display = 'none';
}

function setRatingDetalhes(valor) {
    contribuicaoRatingDetalhes = valor;
    // Lógica visual para destacar o botão selecionado
    document.querySelectorAll('#modal-contribuicao-detalhes .rating-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.style.backgroundColor = ''; // Reset
    });
    const btnSelecionado = document.querySelector(`#modal-contribuicao-detalhes .rating-btn[data-rating-value="${valor}"]`);
    if (btnSelecionado) {
        btnSelecionado.classList.add('selected');
         // Você pode definir cores específicas aqui se o CSS não for suficiente
        btnSelecionado.style.backgroundColor = valor === 1 ? '#007bff' : '#dc3545';
    }
}

async function salvarContribuicaoDetalhes() {
    if (!huntAtualDetalhes || !usuarioDetalhes || !usuarioDetalhes.vip) {
        alert("Apenas VIPs logados podem contribuir.");
        return;
    }

    const xp = parseInt(document.getElementById('inputXpDetalhes').value);
    const gold = parseInt(document.getElementById('inputGoldDetalhes').value);
    const level = parseInt(document.getElementById('inputLevelDetalhes').value);
    const servidor = document.getElementById('servidorDetalhes').value;

    if (isNaN(xp) || isNaN(gold) || isNaN(level) || level <=0 || contribuicaoRatingDetalhes === null || !servidor) {
        alert("Por favor, preencha todos os campos da contribuição corretamente e selecione uma avaliação e servidor.");
        return;
    }

    const novaContribuicao = {
        xp: xp,
        gold: gold,
        level_jogador: level, // Corrigido para o nome do campo no modal
        servidor: servidor,
        avaliacao: contribuicaoRatingDetalhes,
        email_usuario: usuarioDetalhes.email, // Adiciona o email do usuário
        data_contribuicao: new Date().toISOString() // Adiciona data e hora
    };

    // ADICIONAR AO ARQUIVO banco.json
    // Esta é a parte que requer um backend (PHP, Node.js, etc.)
    // Para simulação no frontend ou para uma abordagem com Node.js local:
    // 1. Ler o `banco.json`
    // 2. Encontrar a hunt ou adicioná-la se não existir
    // 3. Adicionar a `novaContribuicao` ao array `contribuicoes` da hunt
    // 4. "Salvar" o `banco.json` modificado
    console.log("Simulando salvamento da contribuição:", novaContribuicao, "para a hunt:", huntAtualDetalhes.nome);
    alert("Contribuição registrada (simulação). Atualize o banco.json manualmente ou implemente o backend.");

    // Para demonstração, vamos atualizar localmente e recarregar as métricas
    if (!huntAtualDetalhes.contribuicoes) {
        huntAtualDetalhes.contribuicoes = [];
    }
    huntAtualDetalhes.contribuicoes.push(novaContribuicao);

    fecharModalContribuicaoDetalhes();
    exibirMetricasComunidade(huntAtualDetalhes); // Atualiza as métricas da comunidade
    exibirMinhasMetricas(huntAtualDetalhes);   // Atualiza as minhas métricas
    
    // Lembre-se: Para salvar permanentemente, você precisará enviar `huntAtualDetalhes.nome` e `novaContribuicao`
    // para um endpoint de backend (ex: 'salvar_contribuicao_detalhada.php')
    // que irá ler o banco.json, encontrar a hunt, adicionar a contribuição, e reescrever o arquivo.
    // Exemplo de chamada fetch para um backend:
    /*
    try {
        const response = await fetch('seu_backend_salvar_contribuicao.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ huntNome: huntAtualDetalhes.nome, contribuicao: novaContribuicao })
        });
        if (!response.ok) throw new Error('Falha ao salvar contribuição no servidor.');
        const resultado = await response.json();
        if (resultado.success) {
            alert("Contribuição salva com sucesso!");
            // Atualizar dados na tela se necessário (pode recarregar a hunt do backend)
            carregarDadosHunt(); // Recarrega tudo para pegar os dados atualizados
        } else {
            alert("Erro ao salvar contribuição: " + (resultado.message || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error("Erro ao salvar contribuição:", error);
        alert("Erro de comunicação ao salvar contribuição.");
    }
    */
}


// --- Inicialização da Página ---
document.addEventListener('DOMContentLoaded', () => {
    carregarUsuarioSessaoDetalhes();
    carregarDadosHunt();
});